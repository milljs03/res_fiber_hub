<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFN Install Tracker</title>
    <link rel="stylesheet" href="style.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide-icons@0.309.0"></script>
</head>

<body>

    <div id="auth-screen" class="auth-screen">
        <div class="auth-box">
            <i data-lucide="list-checks" class="auth-logo"></i>
            <h1 class="auth-title">CFN Install Tracker</h1>
            <p class="auth-text">Please sign in with your @nptel.com account.</p>
            <button id="sign-in-btn" class="btn btn-primary btn-full-width">
                <svg class="btn-icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.56 12.25c0-.78-.07-1.52-.19-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.04v2.84C3.86 21.03 7.66 23 12 23z"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.04C1.32 8.38 1 9.65 1 11.01s.32 2.63 2.04 3.94l3.8-2.86z"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.69l3.15-3.15C17.45 2.18 14.97 1 12 1 7.66 1 3.86 2.97 2.04 5.84l3.8 2.84C6.71 7.31 9.14 5.38 12 5.38z"/>
                </svg>
                Sign in with Google
            </button>
            <p id="auth-error"></p>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <header class="app-header">
            <div class="header-content">
                <div class="header-title">
                    <i data-lucide="list-checks"></i>
                    <h1>CFN Install Tracker</h1>
                </div>
                <div class="user-info">
                    <span id="user-email"></span>
                    <button id="sign-out-btn">Sign Out</button>
                </div>
            </div>
        </header>

        <!-- NEW: DASHBOARD CONTAINER (Full Width) -->
        <div class="dashboard-container">
            <div id="dashboard-card" class="card">
                <!-- Dashboard Header with Toggle -->
                <div class="dashboard-header-toggle">
                    <h2 class="card-title">At a Glance</h2>
                    <button id="dashboard-toggle-btn" class="toggle-btn" aria-expanded="true">
                        <i data-lucide="chevron-down" class="toggle-icon" id="dashboard-toggle-icon"></i>
                    </button>
                </div>
                
                <!-- Collapsible Content Wrapper -->
                <div id="dashboard-content" class="dashboard-content-collapsible active">
                    <!-- First Row: KPI Stats -->
                    <div id="dashboard-stats-grid" class="dashboard-stats-grid">
                        <div id="stats-summary-active-wrapper" class="stat-wrapper">
                            <!-- Active Stats content goes here -->
                        </div>
                        <div id="stats-summary-completed-wrapper" class="stat-wrapper">
                            <!-- Completed Stats content goes here -->
                        </div>
                        <div id="overall-install-time-wrapper" class="stat-wrapper">
                            <!-- Overall Avg Time content goes here -->
                        </div>
                    </div>
                    
                    <!-- Second Row: Charts -->
                    <div id="dashboard-charts-grid" class="dashboard-stats-grid" style="margin-top: 1rem;">
                        <!-- 1. YTD Installs Chart -->
                        <div id="chart-area-box-installs" class="chart-area-box">
                            <h3 class="chart-title">YTD Installs</h3>
                            <div id="chart-area-installs" class="chart-area">
                                <canvas id="installations-chart"></canvas>
                            </div>
                        </div>

                        <!-- 2. Monthly Avg Time Chart -->
                        <div id="chart-area-box-monthly-avg" class="chart-area-box">
                            <h3 class="chart-title">Monthly Avg Install Time (Days)</h3>
                            <div id="chart-area-monthly-avg" class="chart-area">
                                <canvas id="monthly-install-chart"></canvas>
                            </div>
                        </div>
                        
                        <!-- 3. Speed Breakdown Chart -->
                        <div id="chart-area-box-speed" class="chart-area-box">
                            <h3 class="chart-title">Service Speed Breakdown</h3>
                            <div id="chart-area-speed" class="chart-area">
                                <canvas id="speed-breakdown-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END DASHBOARD CONTAINER -->

        <div class="main-grid">

            <div class="card">
                <div class="card-title-header">
                    <h2 class="card-title">Customer List</h2>
                    <button id="new-customer-btn" class="btn btn-primary">
                        New Service Order
                    </button>
                </div>
                
                <div class="search-bar-group">
                    <img src="search.png" alt="" class="search-icon" />
                    <input type="text" id="search-bar" class="form-input" placeholder="Search by name or address...">
                </div>

                <!-- Primary Tab Bar (NEW ELEMENT) -->
                <div id="main-list-tabs" class="main-list-tabs">
                    <button type="button" class="main-list-tab active" data-main-filter="Active">Active Orders</button>
                    <button type="button" class="main-list-tab" data-main-filter="Completed">Completed Orders</button>
                </div>

                <!-- Active View Controls -->
                <div id="active-controls-group">
                    <div class="form-group">
                        <label for="sort-by" class="form-label">Sort by</label>
                        <select id="sort-by" class="form-select">
                            <option value="name">Name (A-Z)</option>
                            <option value="date">Date Added (Newest)</option>
                            <option value="date-oldest">Date Added (Oldest)</option>
                        </select>
                    </div>

                    <!-- Secondary Filter Pills -->
                    <div class="form-group">
                        <label class="form-label">Filter by Status</label>
                        <div id="filter-pills" class="filter-pills">
                            <button type="button" class="filter-pill active" data-filter="All">All</button>
                            <button type="button" class="filter-pill" data-filter="New Order">New Order</button>
                            <button type="button" class="filter-pill" data-filter="Site Survey">Site Survey</button>
                            <button type="button" class="filter-pill" data-filter="NID">NID</button>
                            <button type="button" class="filter-pill" data-filter="On Hold">On Hold</button>
                        </div>
                    </div>
                </div>

                <!-- Completed View Controls -->
                <div id="completed-controls-group" class="hidden">
                    <!-- Completed Sort/Filter Group (Month/Year dropdown) -->
                    <div id="completed-filter-group" class="form-group">
                        <label for="completed-filter-select" class="form-label">Completed Month</label>
                        <select id="completed-filter-select" class="form-select">
                            <!-- Options populated by app.js -->
                        </select>
                    </div>
                </div>
                
                <div id="customer-list-container" class="customer-list-container">
                    <p id="list-loading" class="text-gray-500">Loading customers...</p>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">Customer Details</h2>
                <div id="details-container" data-id="">
                    <div id="loading-overlay">
                        <div id="loading-spinner"></div>
                    </div>

                    <form id="details-form" class="card-content">

                        <!-- === START: NEW STATUS STEPPER === -->
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <div id="status-stepper" class="status-stepper">
                                <!-- Main Progression -->
                                <button type="button" class="step" data-status="New Order" data-page="page-pre-install">
                                    <div class="step-circle">1</div>
                                    <div class="step-label">New Order</div>
                                </button>
                                <div class="step-connector"></div>
                                <button type="button" class="step" data-status="Site Survey" data-page="page-site-survey">
                                    <div class="step-circle">2</div>
                                    <div class="step-label">Site Survey</div>
                                </button>
                                <div class="step-connector"></div>
                                <button type="button" class="step" data-status="NID" data-page="page-nid">
                                    <div class="step-circle">3</div>
                                    <div class="step-label">NID</div>
                                </button>
                                <div class="step-connector"></div>
                                <button type="button" class="step" data-status="Completed" data-page="page-install">
                                    <div class="step-circle">4</div>
                                    <div class="step-label">Completed</div>
                                </button>
                                
                                <!-- Special "On Hold" button - REMOVED FROM HERE -->
                            </div>
                            <!-- This hidden input will store the actual status value for the form -->
                            <input type="hidden" id="details-status" name="details-status" />
                        </div>
                        <!-- === END: NEW STATUS STEPPER === -->


                        <!-- === REMOVED old status dropdown === -->
                        <!-- === REMOVED old details-tabs === -->

                        <div id="page-pre-install" class="details-page active">
                            <div class="form-group">
                                <label class="form-label" for="details-customer-name">Customer Name</label>
                                <div class="field-wrapper">
                                    <input type="text" id="details-customer-name" class="form-input" required>
                                    <button type="button" class="copy-btn" data-target="details-customer-name">
                                        <img src="copy.png" alt="Copy" class="icon-copy" />
                                        <img src="check.png" alt="Copied" class="icon-check" />
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="details-so-number">Service Order #</label>
                                <div class="field-wrapper">
                                    <input type="text" id="details-so-number" class="form-input" required>
                                    <button type="button" class="copy-btn" data-target="details-so-number">
                                        <img src="copy.png" alt="Copy" class="icon-copy" />
                                        <img src="check.png" alt="Copied" class="icon-check" />
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="details-address">Address</label>
                                <div class="field-wrapper">
                                    <textarea id="details-address" rows="3" class="form-textarea"></textarea>
                                    <button type="button" class="copy-btn" data-target="details-address">
                                        <img src="copy.png" alt="Copy" class="icon-copy" />
                                        <img src="check.png" alt="Copied" class="icon-check" />
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="details-speed">Service Speed</label>
                                <div class="field-wrapper">
                                    <!-- Changed to input/text area to maintain flexibility if non-standard speeds are edited -->
                                    <input type="text" id="details-speed" class="form-input"> 
                                    <button type="button" class="copy-btn" data-target="details-speed">
                                        <img src="copy.png" alt="Copy" class="icon-copy" />
                                        <img src="check.png" alt="Copied" class="icon-check" />
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="details-email">Primary Email</label>
                                <div class="field-wrapper">
                                    <input type="email" id="details-email" class="form-input">
                                    <button type="button" class="copy-btn" data-target="details-email">
                                        <img src="copy.png" alt="Copy" class="icon-copy" />
                                        <img src="check.png" alt="Copied" class="icon-check" />
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="details-phone">Primary Phone</label>
                                <div class="field-wrapper">
                                    <input type="tel" id="details-phone" class="form-input">
                                    <button type="button" class="copy-btn" data-target="details-phone">
                                        <img src="copy.png" alt="Copy" class="icon-copy" />
                                        <img src="check.png" alt="Copied" class="icon-check" />
                                    </button>
                                </div>
                            </div>
                            
                            <fieldset class="checklist-group">
                                <legend class="checklist-title">Pre-Install Checklist</legend>
                                <div class="checklist-content">
                                    <div class="checklist-item">
                                        <div class="checklist-item-box">
                                            <input id="check-welcome-email" name="check-welcome-email" type="checkbox" class="form-checkbox">
                                        </div>
                                        <div class="checklist-item-label">
                                            <label for="check-welcome-email">Welcome Email Sent</label>
                                        </div>
                                        <button type="button" id="send-welcome-email-btn">
                                            Send Now
                                        </button>
                                    </div>
                                    <div class="checklist-item">
                                        <div class="checklist-item-box">
                                            <input id="check-site-survey" name="check-site-survey" type="checkbox" class="form-checkbox">
                                        </div>
                                        <div class="checklist-item-label">
                                            <label for="check-site-survey">Added to Site Survey List</label>
                                        </div>
                                    </div>
                                    <div class="checklist-item">
                                        <div class="checklist-item-box">
                                            <input id="check-fiber-list" name="check-fiber-list" type="checkbox" class="form-checkbox">
                                        </div>
                                        <div class="checklist-item-label">
                                            <label for="check-fiber-list">Added to Residential Fiber List</label>
                                        </div>
                                    </div>
                                    <div class="checklist-item">
                                        <div class="checklist-item-box">
                                            <input id="check-repair-shoppr" name="check-repair-shoppr" type="checkbox" class="form-checkbox">
                                        </div>
                                        <div class="checklist-item-label">
                                            <label for="check-repair-shoppr">Added to Repair Shoppr</label>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </div> 
                        <div id="page-site-survey" class="details-page">
                            <fieldset class="checklist-group" style="border-top: none; padding-top: 0;">
                                <legend class="checklist-title">Site Survey</legend>
                                <div class="checklist-content">
                                    <div class="form-group">
                                        <label for="site-survey-notes" class="form-label">Site Survey Notes</label>
                                        <div class="field-wrapper">
                                            <textarea id="site-survey-notes" rows="8" class="form-textarea" style="padding-right: 2.5rem;">
                                            </textarea>
                                            <button type="button" class="copy-btn" data-target="site-survey-notes">
                                                <img src="copy.png" alt="Copy" class="icon-copy" />
                                                <img src="check.png" alt="Copied" class="icon-check" />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </div> 
                        
                        <div id="page-nid" class="details-page">
                            <fieldset class="checklist-group" style="border-top: none; padding-top: 0;">
                                <legend class="checklist-title">NID Work</legend>
                                <div class="checklist-content">
                                    <!-- MOVED: Light Reading @ NID to this new page -->
                                    <div class="form-group">
                                        <label for="nid-light" class="form-label">Light Reading @ NID</label>
                                        <div class="field-wrapper">
                                            <input type="text" id="nid-light" class="form-input" style="padding-right: 2.5rem;">
                                            <button type="button" class="copy-btn" data-target="nid-light">
                                                <img src="copy.png" alt="Copy" class="icon-copy" />
                                                <img src="check.png" alt="Copied" class="icon-check" />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                        
                        <div id="page-install" class="details-page">
                            <fieldset class="checklist-group" style="border-top: none; padding-top: 0;">
                                <legend class="checklist-title">Install Details</legend>
                                <div class="checklist-content">
                                    <div class="form-group">
                                        <label for="install-date" class="form-label">Install Date</label>
                                        <div class="field-wrapper">
                                            <input type="date" id="install-date" class="form-input" style="padding-right: 2.5rem;">
                                            <button type="button" class="copy-btn" data-target="install-date">
                                                <img src="copy.png" alt="Copy" class="icon-copy" />
                                                <img src="check.png" alt="Copied" class="icon-check" />
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="checklist-item">
                                        <div class="checklist-item-box">
                                            <input id="eero-info" name="eero-info" type="checkbox" class="form-checkbox">
                                        </div>
                                        <div class="checklist-item-label">
                                            <label for="eero-info">Eero Insight Info Documented</label>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="extra-equip" class="form-label">Additional Equipment</label>
                                        <div class="field-wrapper">
                                            <textarea id="extra-equip" rows="2" class="form-textarea" style="padding-right: 2.5rem;">
                                            </textarea>
                                            <button type="button" class="copy-btn" data-target="extra-equip">
                                                <img src="copy.png" alt="Copy" class="icon-copy" />
                                                <img src="check.png" alt="Copied" class="icon-check" />
                                            </button>
                                        </div>
                                    </div>

                                    <!-- === NEW INSTALL NOTES FIELD === -->
                                    <div class="form-group">
                                        <label for="install-notes" class="form-label">Install Notes</label>
                                        <div class="field-wrapper">
                                            <textarea id="install-notes" rows="5" class="form-textarea" style="padding-right: 2.5rem;">
                                            </textarea>
                                            <button type="button" class="copy-btn" data-target="install-notes">
                                                <img src="copy.png" alt="Copy" class="icon-copy" />
                                                <img src="check.png" alt="Copied" class="icon-check" />
                                            </button>
                                        </div>
                                    </div>
                                    <!-- === END NEW FIELD === -->

                                    <div class="form-group">
                                        <label for="general-notes" class="form-label">General Notes</label>
                                        <div class="field-wrapper">
                                            <textarea id="general-notes" rows="3" class="form-textarea" style="padding-right: 2.5rem;">
                                            </textarea>
                                            <button type="button" class="copy-btn" data-target="general-notes">
                                                <img src="copy.png" alt="Copy" class="icon-copy" />
                                                <img src="check.png" alt="Copied" class="icon-check" />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                            
                            <!-- MOVED: Post-Install Checklist from page-post-install (now considered part of the final 'Install' stage) -->
                            <fieldset class="checklist-group" style="border-top: 1px solid #e5e7eb; padding-top: 1.25rem;">
                                <legend class="checklist-title">Post-Install Checklist</legend>
                                <div class="checklist-content">
                                    <div class="checklist-item">
                                        <div class="checklist-item-box">
                                            <input id="post-check-fiber" name="post-check-fiber" type="checkbox" class="form-checkbox">
                                        </div>
                                        <div class="checklist-item-label">
                                            <label for="post-check-fiber">Removed from Residential Fiber List</label>
                                        </div>
                                    </div>
                                    <div class="checklist-item">
                                        <div class="checklist-item-box">
                                            <input id="post-check-survey" name="post-check-survey" type="checkbox" class="form-checkbox">
                                        </div>
                                        <div class="checklist-item-label">
                                            <label for="post-check-survey">Removed from Site Survey List</label>
                                        </div>
                                    </div>
                                    <div class="checklist-item">
                                        <div class="checklist-item-box">
                                            <input id="post-check-repair" name="post-check-repair" type="checkbox" class="form-checkbox">
                                        </div>
                                        <div class="checklist-item-label">
                                            <label for="post-check-repair">Updated Repair Shoppr</label>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>

                            <div class="action-buttons" style="border-top: 1px solid #e5e7eb; margin-top: 1.25rem;">
                                <button type="button" id="copy-billing-btn" class="btn btn-secondary">
                                    <i data-lucide="clipboard-list" class="btn-icon"></i>
                                    Copy Info for Billing
                                </button>
                            </div>
                            <!-- END MOVED CONTENT -->

                        </div> 
                        <div class="action-buttons">
                            <button type="button" id="update-customer-btn" class="btn btn-primary">
                                <i data-lucide="save" class="btn-icon"></i>
                                Save Changes
                            </button>
                            
                            <!-- MOVED AND RESTYLED "ON HOLD" BUTTON HERE -->
                            <button type="button" id="on-hold-btn" class="btn btn-warning">
                                <i data-lucide="pause-circle" class="btn-icon"></i>
                                <span>Toggle On Hold</span>
                            </button>

                            <button type="button" id="delete-customer-btn" class="btn btn-danger">
                                <i data-lucide="trash-2" class="btn-icon"></i>
                                Delete Customer
                            </button>
                        </div>

                    </form>
                </div>

                <div id="details-placeholder" class="details-placeholder">
                    <i data-lucide="mouse-pointer-square" style="width: 3rem; height: 3rem; color: #9ca3af; margin: 0 auto;"></i>
                    <p style="margin-top: 0.5rem;">Select a customer from the list to view their details.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-notification"></div>

    <div id="add-customer-modal" class="modal-container">
        <div class="modal-backdrop"></div>
        <div class="modal-panel">
            <div class="modal-header">
                <h2 class="card-title">Add New Customer</h2>
                <button id="modal-close-btn" class="modal-close-btn">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            
            <form id="add-customer-form" class="card-content">
                <!-- PDF Upload Section -->
                <div class="form-group" style="border-bottom: 1px solid #e5e7eb; padding-bottom: 1.25rem;">
                    <label for="pdf-upload" class="form-label" style="font-weight: 600;">Automate from Service Order PDF</label>
                    <input type="file" id="pdf-upload" accept=".pdf" class="form-input" style="padding: 0.5rem 0.75rem; border: 1px solid #d1d5db;">
                    <button type="button" id="process-pdf-btn" class="btn btn-secondary btn-full-width" style="margin-top: 0.75rem;">
                        <i data-lucide="file-text" class="btn-icon"></i>
                        Process PDF & Autofill (Cost-Free)
                    </button>
                    <p id="pdf-status-msg" style="font-size: 0.75rem; color: #4b5563; margin-top: 0.5rem; text-align: center;"></p>
                </div>
                
                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Manual Entry</h3>

                <div class="form-group">
                    <label for="so-number" class="form-label">Service Order #</label>
                    <input type="text" id="so-number" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="customer-name" class="form-label">Customer Name</label>
                    <input type="text" id="customer-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="address" class="form-label">Address</label>
                    <textarea id="address" rows="3" class="form-textarea"></textarea>
                </div>
                <div class="form-group">
                    <label for="customer-email" class="form-label">Primary Email</label>
                    <input type="email" id="customer-email" class="form-input">
                </div>
                <div class="form-group">
                    <label for="customer-phone" class="form-label">Primary Phone</label>
                    <input type="tel" id="customer-phone" class="form-input">
                </div>
                <div class="form-group">
                    <label for="service-speed" class="form-label">Service Speed</label>
                    <select id="service-speed" class="form-select">
                        <option>200 Mbps</option>
                        <option>500 Mbps</option>
                        <option>1 Gbps</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-full-width">
                    <i data-lucide="plus-circle" class="btn-icon"></i>
                    Add Customer
                </button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- NEW: Include PDF.js Library for client-side reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs" type="module"></script>
    <script type="module" src="firebase.js"></script>
    
    <script type="module" src="app.js"></script>

    <script>
        lucide.createIcons();
    </script>
</body>
</html>