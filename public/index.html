<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Res Fiber Hub</title>
    <link rel="icon" type="image/png" href="icons/clock.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { inter: ['Inter', 'sans-serif'] },
                    colors: {
                        gray: { 750: '#2d3748', 850: '#1a202c', 950: '#0d1117' }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-inter text-gray-900 dark:text-gray-100 transition-colors duration-200">

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md text-center max-w-sm w-full">
            <i data-lucide="activity" class="mx-auto h-12 w-12 text-blue-600 mb-4"></i>
            <h1 class="text-2xl font-bold mb-2 dark:text-white">Res Fiber Hub</h1>
            <p class="text-gray-500 mb-6">Sign in to manage fiber installations.</p>
            <button id="sign-in-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition flex items-center justify-center gap-2">
                <i data-lucide="log-in" class="h-4 w-4"></i> Sign in with Google
            </button>
            <p id="auth-error" class="text-red-500 mt-4 text-sm"></p>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="hidden min-h-screen flex flex-col">
        
        <!-- HEADER -->
        <header class="bg-white dark:bg-gray-800 shadow-sm z-20 sticky top-0">
            <div class="w-full px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i data-lucide="activity" class="text-blue-600 shrink-0"></i>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white hidden sm:block">Fiber Hub</h1>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white sm:hidden">Hub</h1>
                </div>
                
                <div class="flex items-center gap-2 sm:gap-4">
                    <button id="toggle-analytics-btn" class="text-sm font-medium text-gray-500 hover:text-blue-600 transition flex items-center gap-1 hidden md:flex">
                        <i data-lucide="bar-chart-2" class="h-4 w-4"></i> Analytics
                    </button>
                    <!-- Mobile analytics icon only -->
                    <button id="toggle-analytics-btn-mobile" class="p-2 text-gray-500 hover:text-blue-600 transition md:hidden" onclick="document.getElementById('toggle-analytics-btn').click()">
                        <i data-lucide="bar-chart-2" class="h-5 w-5"></i>
                    </button>

                    <span id="user-email" class="text-xs sm:text-sm text-gray-500 hidden lg:block"></span>
                    
                    <button id="theme-toggle-btn" class="p-2 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        <i data-lucide="moon" class="hidden dark:block h-4 w-4"></i>
                        <i data-lucide="sun" class="block dark:hidden h-4 w-4"></i>
                    </button>

                    <button id="sign-out-btn" class="text-sm font-medium text-gray-500 hover:text-red-500 transition hidden sm:block">Sign Out</button>
                    <!-- Mobile Sign Out Icon -->
                    <button id="sign-out-btn-mobile" class="p-2 text-gray-500 hover:text-red-500 transition sm:hidden" onclick="document.getElementById('sign-out-btn').click()">
                        <i data-lucide="log-out" class="h-5 w-5"></i>
                    </button>
                    
                    <button id="new-customer-btn" class="bg-blue-600 text-white p-2 sm:px-4 sm:py-2 rounded-md hover:bg-blue-700 text-sm font-medium flex items-center gap-2 transition shadow-sm">
                        <i data-lucide="plus" class="h-4 w-4"></i> <span class="hidden sm:inline">New Order</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- ANALYTICS DASHBOARD (Hidden by default) -->
        <div id="analytics-dashboard" class="hidden bg-gray-50 dark:bg-gray-850 border-b border-gray-200 dark:border-gray-700 p-4 sm:p-6">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-lg font-bold mb-4 dark:text-white">Dashboard Analytics</h2>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-6"> <!-- Expanded columns -->
                    
                    <!-- Stage Breakdown -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow col-span-1 md:col-span-2">
                        <h3 class="text-sm font-semibold text-gray-500 mb-2">Active Pipeline Stages</h3>
                        <div id="analytics-stages-list" class="space-y-2">
                            <!-- Injected via JS -->
                        </div>
                        <div class="mt-3 pt-2 border-t border-gray-100 dark:border-gray-700 flex justify-between items-center">
                            <span class="text-sm font-bold text-gray-700 dark:text-gray-300">Total in Pipeline</span>
                            <span id="analytics-total-pipeline" class="text-sm font-bold text-blue-600 dark:text-blue-400">0</span>
                        </div>
                    </div>

                    <!-- Monthly Installs Chart -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow col-span-1 md:col-span-2">
                        <h3 class="text-sm font-semibold text-gray-500 mb-2">Monthly Installs</h3>
                        <div class="h-40">
                            <canvas id="chart-monthly-installs"></canvas>
                        </div>
                    </div>

                    <!-- Speed Tier Chart -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow col-span-1 md:col-span-2">
                        <h3 class="text-sm font-semibold text-gray-500 mb-2">Speed Tier Distribution</h3>
                        <div class="h-40 flex justify-center">
                            <canvas id="chart-speed-tiers"></canvas>
                        </div>
                    </div>

                    <!-- Customer Count by Town -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow col-span-1 md:col-span-3">
                        <h3 class="text-sm font-semibold text-gray-500 mb-2">Customers by Town</h3>
                        <div class="h-40">
                            <canvas id="chart-towns"></canvas>
                        </div>
                    </div>

                    <!-- Metrics Group -->
                    <div class="col-span-1 md:col-span-3 grid grid-cols-2 gap-6">
                        <!-- Average Install Time -->
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex flex-col justify-center items-center text-center">
                            <h3 class="text-sm font-semibold text-gray-500 mb-2">Avg. Install Time</h3>
                            <div class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="analytics-avg-time">
                                -- Days
                            </div>
                            <p class="text-xs text-gray-400 mt-2">From Creation to Install Date</p>
                        </div>
                        <!-- Total Customers Count -->
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex flex-col justify-center items-center text-center">
                            <h3 class="text-sm font-semibold text-gray-500 mb-2">Total Customers</h3>
                            <div class="text-3xl font-bold text-green-600 dark:text-green-400" id="analytics-total-customers">
                                0
                            </div>
                            <p class="text-xs text-gray-400 mt-2">All Time (Non-Archived)</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- MAIN DASHBOARD -->
        <main class="flex-1 w-full px-2 sm:px-6 lg:px-8 py-4 sm:py-8">
            
            <!-- CONTROLS SECTION -->
            <div class="mb-6 space-y-4">
                
                <!-- General Notes Section -->
                <div class="bg-yellow-50 dark:bg-yellow-900/10 border border-yellow-200 dark:border-yellow-900/30 rounded-lg p-3">
                    <div class="flex justify-between items-center mb-1">
                        <label for="app-general-notes" class="text-xs font-bold text-yellow-700 dark:text-yellow-500 uppercase tracking-wider flex items-center gap-1">
                            <i data-lucide="clipboard-list" class="w-3 h-3"></i> General Hub Notes
                        </label>
                        <span id="notes-status" class="text-xs text-yellow-600/70 dark:text-yellow-500/70 italic opacity-0 transition-opacity duration-500">Saved</span>
                    </div>
                    <textarea id="app-general-notes" rows="2" class="w-full bg-transparent border-0 p-0 text-sm text-gray-700 dark:text-gray-300 focus:ring-0 resize-none placeholder-yellow-700/30 dark:placeholder-yellow-500/30" placeholder="Type general notes here (autosaves)..."></textarea>
                </div>

                <!-- MAIN TABS (Active / Billing / Archived) -->
                <!-- Make tabs scrollable on very small screens if needed, or wrap -->
                <div class="flex overflow-x-auto pb-1 sm:pb-0 space-x-1 bg-gray-200 dark:bg-gray-700 p-1 rounded-lg w-full sm:w-fit scrollbar-hide" id="main-list-tabs">
                    <button class="tab-btn active flex-1 sm:flex-none px-4 py-2 rounded-md text-sm font-medium transition-all focus:outline-none whitespace-nowrap" data-main-filter="Active">Active</button>
                    <button class="tab-btn flex-1 sm:flex-none px-4 py-2 rounded-md text-sm font-medium transition-all focus:outline-none whitespace-nowrap" data-main-filter="Billing">Billing</button>
                    <button class="tab-btn flex-1 sm:flex-none px-4 py-2 rounded-md text-sm font-medium transition-all focus:outline-none whitespace-nowrap" data-main-filter="Archived">Archived</button>
                </div>

                <!-- SEARCH & FILTER BAR -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <!-- Search -->
                    <div class="relative w-full md:w-96">
                        <i data-lucide="search" class="absolute left-3 top-2.5 h-4 w-4 text-gray-400"></i>
                        <input type="text" id="search-bar" placeholder="Search customer or address..." 
                            class="w-full pl-10 pr-4 py-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition text-sm sm:text-base">
                    </div>

                    <!-- Stage Pills -->
                    <div id="filter-pills" class="flex items-center gap-2 overflow-x-auto pb-2 md:pb-0 scrollbar-hide w-full md:w-auto -mx-2 px-2 md:mx-0 md:px-0">
                        <button class="pill active whitespace-nowrap px-3 py-1 rounded-full text-xs font-medium border transition focus:outline-none" data-filter="All">All Stages</button>
                        <button class="pill whitespace-nowrap px-3 py-1 rounded-full text-xs font-medium border transition focus:outline-none" data-filter="New Order">New</button>
                        <button class="pill whitespace-nowrap px-3 py-1 rounded-full text-xs font-medium border transition focus:outline-none" data-filter="Site Survey Ready">Survey</button>
                        <button class="pill whitespace-nowrap px-3 py-1 rounded-full text-xs font-medium border transition focus:outline-none" data-filter="Torys List">Construction</button>
                        <button class="pill whitespace-nowrap px-3 py-1 rounded-full text-xs font-medium border transition focus:outline-none" data-filter="NID Ready">NIDs</button>
                        <button class="pill whitespace-nowrap px-3 py-1 rounded-full text-xs font-medium border transition focus:outline-none" data-filter="Install Ready">Install</button>
                        <button class="pill whitespace-nowrap px-3 py-1 rounded-full text-xs font-medium border transition focus:outline-none" data-filter="On Hold">On Hold</button>
                    </div>
                </div>
            </div>

            <!-- DATA TABLE -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden border border-gray-200 dark:border-gray-700">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-750">
                            <tr>
                                <th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Customer Name</th>
                                <th scope="col" class="hidden sm:table-cell px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Address</th>
                                <th scope="col" class="hidden md:table-cell px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Speed</th>
                                <th scope="col" class="hidden lg:table-cell px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date Created</th>
                                <th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                            </tr>
                        </thead>
                        <tbody id="contractsTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
                <!-- Empty State -->
                <div id="table-empty-state" class="hidden flex flex-col items-center justify-center p-12 text-center text-gray-500 dark:text-gray-400">
                    <i data-lucide="inbox" class="h-10 w-10 mb-2 text-gray-300 dark:text-gray-600"></i>
                    <p>No orders found.</p>
                </div>
                <!-- Loading State -->
                 <div id="table-loading" class="flex flex-col items-center justify-center p-12 text-center text-gray-500 dark:text-gray-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
                    <p>Loading records...</p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- TOAST NOTIFICATION -->
    <div id="toast-notification" class="fixed bottom-4 right-4 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg transform transition-all translate-y-20 opacity-0 z-50 flex items-center gap-2 max-w-[90vw] sm:max-w-sm"></div>
    <!-- Loading Overlay for Actions -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white/50 dark:bg-black/50 flex items-center justify-center z-[200]">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
    </div>


    <!-- ================= MODALS ================= -->

    <!-- 1. ADD CUSTOMER MODAL (Maintained original logic inputs) -->
    <div id="add-customer-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4 overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 w-full max-w-lg rounded-xl shadow-2xl p-6 relative my-auto">
            <button id="modal-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition"><i data-lucide="x"></i></button>
            
            <h2 class="text-xl font-bold mb-6 dark:text-white flex items-center gap-2">
                <i data-lucide="file-plus" class="text-blue-500"></i> New Service Order
            </h2>
            
            <form id="add-customer-form" class="space-y-4">
                <!-- PDF DROP ZONE -->
                <div id="pdf-drop-zone" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-750 transition group">
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-full w-fit mx-auto mb-3 group-hover:scale-110 transition">
                        <i data-lucide="upload-cloud" class="h-6 w-6 text-blue-500"></i>
                    </div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300" id="selected-file-name">Click or Drop PDF to Auto-fill</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Supports Service Order PDFs</p>
                    <input type="file" id="pdf-upload" accept=".pdf" class="hidden">
                </div>
                
                <div class="flex items-center justify-between">
                    <button type="button" id="process-pdf-btn" class="text-xs bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 px-3 py-1 rounded text-gray-700 dark:text-gray-300 transition" disabled>Process PDF</button>
                    <p id="pdf-status-msg" class="text-xs text-blue-500 font-medium"></p>
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 my-4"></div>

                <!-- MANUAL INPUTS -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">SO Number</label>
                        <input type="text" id="so-number" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Customer Name</label>
                        <input type="text" id="customer-name" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Address</label>
                    <textarea id="address" rows="2" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Email</label>
                        <input type="email" id="customer-email" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Speed</label>
                        <select id="service-speed" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <option>200 Mbps</option>
                            <option>500 Mbps</option>
                            <option>1 Gbps</option>
                        </select>
                    </div>
                </div>
                
                <!-- CONTACTS SECTION (Simplified for Modal) -->
                <div>
                     <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Contacts</label>
                     <div id="modal-contacts-list" class="contacts-list mb-2"></div>
                     <div id="modal-add-contact-form" class="hidden bg-gray-50 dark:bg-gray-700 p-2 rounded mb-2">
                        <div class="flex gap-2 mb-2">
                             <select id="modal-new-contact-type" class="text-sm border rounded p-1 dark:bg-gray-600 dark:text-white"><option value="Mobile">Mobile</option><option value="Work">Work</option><option value="Home">Home</option><option value="Other">Other</option></select>
                             <input type="text" id="modal-new-contact-number" placeholder="Number" class="text-sm border rounded p-1 w-full dark:bg-gray-600 dark:text-white">
                        </div>
                        <input type="text" id="modal-new-contact-name" placeholder="Name (e.g. Spouse)" class="text-sm border rounded p-1 w-full mb-2 dark:bg-gray-600 dark:text-white">
                        <div class="flex justify-end gap-2">
                            <button type="button" id="modal-cancel-add-contact" class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded">Cancel</button>
                            <button type="button" id="modal-confirm-add-contact" class="text-xs px-2 py-1 bg-blue-600 text-white rounded">Add</button>
                        </div>
                     </div>
                     <button type="button" id="modal-show-add-contact-btn" class="text-xs flex items-center gap-1 text-blue-600 hover:underline"><i data-lucide="plus" class="w-3 h-3"></i> Add Contact</button>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-2.5 rounded-lg hover:bg-blue-700 font-medium transition shadow-lg shadow-blue-500/30 mt-2">Create Order</button>
            </form>
        </div>
    </div>

    <!-- 2. DETAILS MODAL (The Original Content but in a Modal Wrapper) -->
    <div id="details-container-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4 overflow-y-auto">
        <!-- This div acts as the container el.detailsContainer logic looks for -->
        <div id="details-container" class="bg-white dark:bg-gray-800 w-full max-w-4xl rounded-xl shadow-2xl relative flex flex-col max-h-[90vh] overflow-hidden my-auto" data-id="">
            
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-4 sm:px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-850 shrink-0">
                <div class="flex items-center gap-2 sm:gap-3">
                    <button id="mobile-back-btn" class="md:hidden text-gray-500"><i data-lucide="arrow-left"></i></button>
                    <div>
                        <h2 id="header-customer-name" class="text-base sm:text-lg font-bold text-gray-900 dark:text-white truncate max-w-[150px] sm:max-w-xs">Customer Name</h2>
                        <span id="header-so-number" class="text-xs font-mono bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded">SO# 000000</span>
                    </div>
                </div>
                <div class="flex items-center gap-1 sm:gap-2">
                     <button type="button" id="update-customer-btn" class="px-2 py-1 sm:px-3 sm:py-1.5 text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600">Save</button>
                     <button type="button" id="save-and-progress-btn" class="px-2 py-1 sm:px-3 sm:py-1.5 text-xs sm:text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 flex items-center gap-1">Next <i data-lucide="arrow-right" class="w-3 h-3 sm:w-4 sm:h-4"></i></button>
                     <button id="details-modal-close-btn" class="ml-1 sm:ml-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i data-lucide="x" class="w-5 h-5 sm:w-6 sm:h-6"></i></button>
                </div>
            </div>

            <!-- Scrollable Body -->
            <form id="details-form" class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6">
                
                <!-- Stepper -->
                <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded-lg border border-gray-200 dark:border-gray-700 overflow-x-auto scrollbar-hide">
                    <div id="status-stepper" class="flex items-center min-w-max">
                        <!-- Step nodes injected by CSS/JS structure -->
                        <button type="button" class="step-node" data-status="New Order" data-page="page-pre-install">New</button>
                        <button type="button" class="step-node" data-status="Site Survey Ready" data-page="page-site-survey">Survey</button>
                        <button type="button" class="step-node" data-status="Torys List" data-page="page-torys-list">Construction</button>
                        <button type="button" class="step-node" data-status="NID Ready" data-page="page-nid">NID</button>
                        <button type="button" class="step-node" data-status="Install Ready" data-page="page-install-ready">Ready</button>
                        <button type="button" class="step-node" data-status="Completed" data-page="page-install">Done</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Column 1: Info -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-sm font-bold uppercase text-gray-500 dark:text-gray-400">Customer Info</h3>
                            <button type="button" id="view-so-btn" class="text-xs text-blue-600 hover:underline">View PDF</button>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                             <div class="col-span-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">Name</label>
                                <div class="relative">
                                    <input type="text" id="details-customer-name" class="form-input">
                                    <button type="button" class="copy-btn copy-icon-abs" data-target="details-customer-name"><i data-lucide="copy"></i></button>
                                </div>
                             </div>
                             <div class="col-span-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">SO #</label>
                                <div class="relative">
                                    <input type="text" id="details-so-number" class="form-input">
                                    <button type="button" class="copy-btn copy-icon-abs" data-target="details-so-number"><i data-lucide="copy"></i></button>
                                </div>
                             </div>
                             <div class="col-span-2">
                                <label class="text-xs text-gray-500 dark:text-gray-400">Address</label>
                                <div class="relative">
                                    <input type="text" id="details-address" class="form-input">
                                    <button type="button" class="copy-btn copy-icon-abs" data-target="details-address"><i data-lucide="copy"></i></button>
                                </div>
                             </div>
                             <div class="col-span-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">Email</label>
                                <div class="relative">
                                    <input type="email" id="details-email" class="form-input">
                                    <button type="button" class="copy-btn copy-icon-abs" data-target="details-email"><i data-lucide="copy"></i></button>
                                </div>
                             </div>
                             <div class="col-span-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">Speed</label>
                                <input type="text" id="details-speed" class="form-input">
                             </div>
                        </div>

                        <!-- Contacts -->
                        <div>
                            <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Contacts</label>
                            <div id="details-contacts-container">
                                <div id="details-contacts-list" class="contacts-list mb-2"></div>
                                <div id="details-add-contact-form" class="hidden bg-gray-50 dark:bg-gray-700 p-2 rounded mb-2">
                                    <div class="flex gap-2 mb-2">
                                         <select id="details-new-contact-type" class="text-sm border rounded p-1 dark:bg-gray-600 dark:text-white"><option value="Mobile">Mobile</option><option value="Work">Work</option><option value="Home">Home</option><option value="Other">Other</option></select>
                                         <input type="text" id="details-new-contact-number" placeholder="Number" class="text-sm border rounded p-1 w-full dark:bg-gray-600 dark:text-white">
                                    </div>
                                    <input type="text" id="details-new-contact-name" placeholder="Name" class="text-sm border rounded p-1 w-full mb-2 dark:bg-gray-600 dark:text-white">
                                    <div class="flex justify-end gap-2">
                                        <button type="button" id="details-cancel-add-contact" class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded">Cancel</button>
                                        <button type="button" id="details-confirm-add-contact" class="text-xs px-2 py-1 bg-blue-600 text-white rounded">Add</button>
                                    </div>
                                </div>
                                <button type="button" id="details-show-add-contact-btn" class="text-xs flex items-center gap-1 text-blue-600 hover:underline"><i data-lucide="plus" class="w-3 h-3"></i> Add Contact</button>
                            </div>
                        </div>
                        
                        <!-- General Notes -->
                         <div>
                            <label class="text-xs text-gray-500 dark:text-gray-400">General Notes</label>
                            <textarea id="details-general-notes" rows="3" class="form-input"></textarea>
                         </div>
                    </div>

                    <!-- Column 2: Stage Actions -->
                    <div class="bg-white dark:bg-gray-800 border-2 border-blue-100 dark:border-blue-900 rounded-lg p-4 shadow-sm">
                         <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100 dark:border-gray-700">
                             <h3 id="current-stage-title" class="font-bold text-lg text-blue-700 dark:text-blue-400">Stage Details</h3>
                             <button type="button" id="header-move-back-btn" class="text-xs text-gray-400 hover:text-gray-600 flex items-center gap-1"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> Revert</button>
                         </div>

                         <!-- DYNAMIC PAGES -->
                         <div id="page-pre-install" class="details-page active space-y-3">
                              <label class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600">
                                  <div class="flex items-center gap-2">
                                      <input type="checkbox" id="check-welcome-email" class="w-4 h-4 text-blue-600">
                                      <span class="text-sm dark:text-gray-200">Welcome Email Sent</span>
                                  </div>
                                  <button type="button" id="send-welcome-email-btn" class="text-xs bg-white dark:bg-gray-600 border px-2 py-1 rounded">Send</button>
                              </label>
                              <label class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600">
                                  <input type="checkbox" id="check-site-survey" class="w-4 h-4 text-blue-600">
                                  <span class="text-sm dark:text-gray-200">Added to Site Survey List</span>
                              </label>
                              <label class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600">
                                  <input type="checkbox" id="check-fiber-list" class="w-4 h-4 text-blue-600">
                                  <span class="text-sm dark:text-gray-200">Added to Fiber List</span>
                              </label>
                              <label class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600">
                                  <input type="checkbox" id="check-repair-shoppr" class="w-4 h-4 text-blue-600">
                                  <span class="text-sm dark:text-gray-200">Added to Repair Shoppr</span>
                              </label>
                         </div>

                         <div id="page-site-survey" class="details-page space-y-3">
                             <label class="text-sm dark:text-gray-300">Site Survey Notes</label>
                             <textarea id="site-survey-notes" rows="6" class="form-input"></textarea>
                         </div>

                         <div id="page-torys-list" class="details-page space-y-3">
                             <label class="flex items-center gap-2 p-3 bg-blue-50 dark:bg-blue-900/30 rounded border border-blue-200 dark:border-blue-800">
                                  <input type="checkbox" id="check-torys-list" class="w-5 h-5 text-blue-600">
                                  <span class="font-medium text-blue-900 dark:text-blue-100">Added to Construction List</span>
                              </label>
                              <label class="text-sm dark:text-gray-300 mt-4 block">Drop Notes</label>
                              <textarea id="drop-notes" rows="4" class="form-input"></textarea>
                         </div>

                         <div id="page-nid" class="details-page space-y-3">
                              <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded text-sm text-center">
                                  Splice Completed: <span id="splice-complete-date" class="font-bold">N/A</span>
                              </div>
                              <div>
                                  <label class="text-sm dark:text-gray-300">Light Reading</label>
                                  <input type="text" id="nid-light" class="form-input">
                              </div>
                              <input type="hidden" id="details-nid-issues" />
                              <button type="button" id="return-splice-btn" class="w-full py-2 text-red-600 border border-red-200 bg-red-50 hover:bg-red-100 rounded text-sm hidden">Reject Splice</button>
                         </div>

                         <div id="page-install-ready" class="details-page space-y-3">
                              <label class="flex items-center gap-2 p-4 bg-green-50 dark:bg-green-900/30 rounded border border-green-200 dark:border-green-800">
                                  <input type="checkbox" id="check-install-ready" class="w-5 h-5 text-green-600">
                                  <span class="font-medium text-green-900 dark:text-green-100">Install Scheduled</span>
                              </label>
                         </div>

                         <div id="page-install" class="details-page space-y-3">
                              <div>
                                  <label class="text-sm dark:text-gray-300">Install Date</label>
                                  <input type="date" id="install-date" class="form-input">
                              </div>
                              <div>
                                  <label class="text-sm dark:text-gray-300">Additional Equipment</label>
                                  <textarea id="extra-equip" rows="2" class="form-input"></textarea>
                              </div>
                              <div>
                                  <label class="text-sm dark:text-gray-300">Install Notes</label>
                                  <textarea id="install-notes" rows="3" class="form-input"></textarea>
                              </div>
                              
                              <div class="border-t pt-2 mt-2">
                                  <h4 class="text-xs font-bold uppercase text-gray-500 mb-2">Post-Install</h4>
                                  <div class="space-y-1">
                                      <label class="flex items-center gap-2"><input type="checkbox" id="check-exempt-from-stats"><span class="text-sm dark:text-gray-300">Exempt from Stats</span></label>
                                      <label class="flex items-center gap-2"><input type="checkbox" id="eero-info"><span class="text-sm dark:text-gray-300">Eero Info</span></label>
                                      <label class="flex items-center gap-2"><input type="checkbox" id="post-check-fiber"><span class="text-sm dark:text-gray-300">Remove from Fiber List</span></label>
                                      <label class="flex items-center gap-2"><input type="checkbox" id="post-check-survey"><span class="text-sm dark:text-gray-300">Remove from Survey</span></label>
                                      <label class="flex items-center gap-2"><input type="checkbox" id="post-check-repair"><span class="text-sm dark:text-gray-300">Update Repair Shoppr</span></label>
                                      <label class="flex items-center gap-2"><input type="checkbox" id="bill-info"><span class="text-sm dark:text-gray-300">Email to Billing</span></label>
                                  </div>
                              </div>

                              <div id="completed-actions-div" class="hidden grid grid-cols-2 gap-2 mt-4">
                                  <button type="button" id="copy-billing-btn" class="col-span-2 py-2 bg-gray-200 dark:bg-gray-700 rounded text-sm hover:bg-gray-300 dark:hover:bg-gray-600">Copy Billing Info</button>
                                  <button type="button" id="archive-customer-btn" class="py-2 bg-gray-200 dark:bg-gray-700 rounded text-sm hover:bg-gray-300 dark:hover:bg-gray-600">Archive</button>
                                  <button type="button" id="unarchive-customer-btn" class="hidden py-2 bg-gray-200 dark:bg-gray-700 rounded text-sm hover:bg-gray-300 dark:hover:bg-gray-600">Unarchive</button>
                              </div>
                         </div>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="flex justify-between items-center pt-4 border-t border-gray-100 dark:border-gray-700 shrink-0">
                    <button type="button" id="on-hold-btn" class="text-orange-600 border border-orange-200 hover:bg-orange-50 px-3 py-1.5 rounded text-sm">Hold</button>
                    <button type="button" id="delete-customer-btn" class="text-red-600 hover:bg-red-50 px-3 py-1.5 rounded text-sm">Delete Order</button>
                </div>

                <!-- Hidden inputs -->
                <input type="hidden" id="details-status" name="details-status" />
                <button type="button" id="header-save-btn" class="hidden"></button>
                <button type="button" id="header-save-and-progress-btn" class="hidden"></button>
            </form>
        </div>
    </div>

    <!-- Required Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs" type="module"></script>
    <script type="module" src="firebase.js"></script>
    <script type="module" src="app.js"></script>
    
    <script>
        // Init Lucide icons
        window.addEventListener('load', () => {
            if (window.lucide) window.lucide.createIcons();
        });
    </script>
</body>
</html>