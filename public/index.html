<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFN Install Tracker</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="icons/clock.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-box">
            <i data-lucide="activity" class="auth-logo-img"></i>
            <h1 class="auth-title">CFN Install Tracker</h1>
            <p class="auth-text">Sign in to manage fiber installations.</p>
            <button id="sign-in-btn" class="btn btn-primary btn-full-width">
                <i data-lucide="log-in" class="btn-icon"></i>
                Sign in with Google
            </button>
            <p id="auth-error"></p>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="hidden">
        
        <!-- MAIN NAVIGATION -->
        <nav class="app-nav">
            <div class="nav-content">
                <div class="nav-brand">
                    <i data-lucide="activity" class="brand-icon"></i>
                    <span class="brand-name">CFN Tracker</span>
                </div>
                <div class="nav-actions">
                    <span id="user-email" class="user-email-display"></span>
                    <div class="nav-divider"></div>
                    <a href="map.html" class="btn btn-sm btn-ghost">
                        <i data-lucide="map"></i> Map
                    </a>
                    <button id="sign-out-btn" class="btn btn-sm btn-ghost">
                        <i data-lucide="log-out"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- DASHBOARD SUMMARY (Compact) -->
        <div class="dashboard-bar">
            <div class="dashboard-stats-row">
                <div id="stats-summary-active-wrapper" class="stat-compact"></div>
                <div id="stats-summary-completed-wrapper" class="stat-compact"></div>
                <div id="overall-install-time-wrapper" class="stat-compact"></div>
                <div class="flex-spacer"></div>
                <button id="toggle-analytics-btn" class="btn btn-sm btn-secondary">
                    <i data-lucide="bar-chart-2"></i> Analytics
                </button>
            </div>
            
            <!-- Expanded Analytics (Hidden by default) -->
            <div id="dashboard-analytics-panel" class="analytics-panel hidden">
                <div class="chart-grid">
                    <div class="chart-card">
                        <h4>YTD Installs</h4>
                        <div class="chart-wrapper"><canvas id="installations-chart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h4>Avg Install Time (Days)</h4>
                        <div class="chart-wrapper"><canvas id="monthly-install-chart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h4>Speed Breakdown</h4>
                        <div class="chart-wrapper"><canvas id="speed-breakdown-chart"></canvas></div>
                    </div>
                </div>
                <div class="notes-section" style="margin-top: 1rem;">
                    <div class="notes-header" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <h4 style="margin:0; color: var(--text-muted);">Dashboard Notes</h4>
                        <button id="save-dashboard-notes-btn" class="btn btn-xs btn-primary">Save Notes</button>
                    </div>
                    <textarea id="dashboard-general-notes" rows="2" class="form-textarea" placeholder="Team announcements or reminders..."></textarea>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT LAYOUT -->
        <div class="layout-container">
            
            <!-- LEFT COLUMN: CUSTOMER LIST -->
            <aside class="list-column">
                <div class="list-header">
                    <div class="list-actions-top">
                        <div class="search-wrapper">
                            <i data-lucide="search" class="search-icon"></i>
                            <input type="text" id="search-bar" placeholder="Search customers...">
                        </div>
                        <button id="new-customer-btn" class="btn btn-primary btn-icon-only" title="New Order">
                            <i data-lucide="plus"></i>
                        </button>
                    </div>
                    
                    <div class="filter-tabs" id="main-list-tabs">
                        <button class="tab-btn active" data-main-filter="Active">Active</button>
                        <button class="tab-btn" data-main-filter="Completed">Done</button>
                        <button class="tab-btn" data-main-filter="Archived">Archive</button>
                    </div>

                    <div id="active-controls-group" class="filter-controls">
                        <div class="filter-pills" id="filter-pills">
                            <button class="pill active" data-filter="All">All</button>
                            <button class="pill" data-filter="New Order">New</button>
                            <button class="pill" data-filter="Site Survey Ready">Survey</button>
                            <button class="pill" data-filter="Torys List">Tory's</button>
                            <button class="pill" data-filter="NID Ready">NID</button>
                            <button class="pill" data-filter="Install Ready">Ready</button>
                            <button class="pill" data-filter="On Hold">Hold</button>
                        </div>
                        <select id="sort-by" class="select-sm full-width" style="margin-top: 0.5rem;">
                            <option value="name">Name (A-Z)</option>
                            <option value="date">Newest First</option>
                            <option value="date-oldest">Oldest First</option>
                        </select>
                    </div>

                    <div id="completed-controls-group" class="filter-controls hidden">
                        <select id="completed-filter-select" class="select-sm full-width"></select>
                        <div id="completed-filter-results" class="filter-results-text hidden"></div>
                    </div>
                </div>

                <div id="customer-list-container" class="list-content">
                    <div class="empty-state">Loading...</div>
                </div>
            </aside>

            <!-- RIGHT COLUMN: DETAILS PANEL -->
            <main class="details-column">
                
                <!-- EMPTY STATE -->
                <div id="details-placeholder" class="details-empty-state">
                    <div class="empty-icon-bg"><i data-lucide="mouse-pointer-2"></i></div>
                    <h3>Select a Customer</h3>
                    <p>Click on an order from the list to view details and manage workflows.</p>
                </div>

                <!-- LOADING OVERLAY -->
                <div id="loading-overlay" class="loading-overlay hidden">
                    <div class="spinner"></div>
                </div>

                <!-- DETAILS FORM CONTAINER -->
                <div id="details-container" class="details-wrapper hidden" data-id="">
                    
                    <!-- STICKY HEADER -->
                    <header class="details-sticky-header">
                        <div class="header-left">
                            <button id="mobile-back-btn" class="btn btn-ghost mobile-only"><i data-lucide="arrow-left"></i></button>
                            <div class="customer-identity">
                                <h2 id="header-customer-name">Customer Name</h2>
                                <span id="header-so-number" class="so-badge">SO# 000000</span>
                            </div>
                        </div>
                        <div class="header-right">

                            <button type="button" id="update-customer-btn" class="btn btn-secondary">
                                Save
                            </button>
                            <button type="button" id="save-and-progress-btn" class="btn btn-primary">
                                Next Step <i data-lucide="arrow-right"></i>
                            </button>
                        </div>
                    </header>

                    <!-- SCROLLABLE CONTENT -->
                    <form id="details-form" class="details-scroll-content">
                        
                        <!-- PROGRESS STEPPER -->
                        <div class="section-card no-padding">
                            <div id="status-stepper" class="stepper-container">
                                <button type="button" class="step-node" data-status="New Order" data-page="page-pre-install">New</button>
                                <button type="button" class="step-node" data-status="Site Survey Ready" data-page="page-site-survey">Survey</button>
                                <button type="button" class="step-node" data-status="Torys List" data-page="page-torys-list">Tory's</button>
                                <button type="button" class="step-node" data-status="NID Ready" data-page="page-nid">NID</button>
                                <button type="button" class="step-node" data-status="Install Ready" data-page="page-install-ready">Ready</button>
                                <button type="button" class="step-node" data-status="Completed" data-page="page-install">Done</button>
                            </div>
                        </div>

                        <!-- CUSTOMER INFO GRID -->
                        <div class="section-card">

                            <div class="section-header">
                                <h3>Customer Information</h3>
                                <button type="button" id="view-so-btn" class="btn btn-xs btn-ghost">View PDF</button>
                            </div>
                            <div class="input-grid">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <div class="input-wrapper">
                                        <input type="text" id="details-customer-name" class="form-control">
                                        <button type="button" class="copy-btn copy-icon" data-target="details-customer-name"><i data-lucide="copy"></i></button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Service Order #</label>
                                    <div class="input-wrapper">
                                        <input type="text" id="details-so-number" class="form-control">
                                        <button type="button" class="copy-btn copy-icon" data-target="details-so-number"><i data-lucide="copy"></i></button>
                                    </div>
                                </div>
                                <div class="form-group span-2">
                                    <label>Address</label>
                                    <div class="input-wrapper">
                                        <input type="text" id="details-address" class="form-control">
                                        <button type="button" class="copy-btn copy-icon" data-target="details-address"><i data-lucide="copy"></i></button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <div class="input-wrapper">
                                        <input type="email" id="details-email" class="form-control">
                                        <button type="button" class="copy-btn copy-icon" data-target="details-email"><i data-lucide="copy"></i></button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <div class="input-wrapper">
                                        <input type="tel" id="details-phone" class="form-control">
                                        <button type="button" class="copy-btn copy-icon" data-target="details-phone"><i data-lucide="copy"></i></button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Speed</label>
                                    <div class="input-wrapper">
                                        <input type="text" id="details-speed" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- GENERAL NOTES -->
                        <div class="section-card">
                            <div class="section-header">
                                <h3>General Notes</h3>
                            </div>
                            <textarea id="details-general-notes" rows="3" class="form-textarea" placeholder="Add important notes here..."></textarea>
                        </div>

                        <!-- DYNAMIC STAGE CONTENT -->
                        <div id="stage-content-area" class="section-card highlight-card">

                            <div class="section-header">
                                                                                                                     <button type="button" id="header-move-back-btn" class="btn btn-sm btn-secondary hidden" title="Revert Step">
                                <i data-lucide="rotate-ccw"></i>
                            </button>
                                <h3 id="current-stage-title">Stage Details</h3>
                            </div>

                            <!-- Page: Pre-Install -->
                            <div id="page-pre-install" class="details-page active">
                                <div class="checklist-stack">
                                    <label class="checkbox-row">
                                        <input type="checkbox" id="check-welcome-email" name="check-welcome-email">
                                        <span>Welcome Email Sent</span>
                                        <button type="button" id="send-welcome-email-btn" class="btn btn-xs btn-secondary" style="margin-left:auto;">Send</button>
                                    </label>
                                    <label class="checkbox-row">
                                        <input type="checkbox" id="check-site-survey" name="check-site-survey">
                                        <span>Added to Site Survey List</span>
                                    </label>
                                    <label class="checkbox-row">
                                        <input type="checkbox" id="check-fiber-list" name="check-fiber-list">
                                        <span>Added to Residential Fiber List</span>
                                    </label>
                                    <label class="checkbox-row">
                                        <input type="checkbox" id="check-repair-shoppr" name="check-repair-shoppr">
                                        <span>Added to Repair Shoppr</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Page: Site Survey -->
                            <div id="page-site-survey" class="details-page">
                                <label class="form-label">Site Survey Notes</label>
                                <textarea id="site-survey-notes" rows="4" class="form-textarea"></textarea>
                            </div>

                            <!-- Page: Tory's List -->
                            <div id="page-torys-list" class="details-page">
                                <label class="checkbox-row main-check">
                                    <input type="checkbox" id="check-torys-list" name="check-torys-list">
                                    <span>Added to Tory's List</span>
                                </label>
                                <div class="spacer"></div>
                                <label class="form-label">Drop Notes</label>
                                <textarea id="drop-notes" rows="3" class="form-textarea"></textarea>
                            </div>

                            <!-- Page: NID Ready -->
                            <div id="page-nid" class="details-page">
                                <div class="info-row" style="margin-bottom:1rem;">
                                    <span class="label" style="font-weight:600; font-size:0.9rem;">Splice Completed: </span>
                                    <span id="splice-complete-date" class="value">N/A</span>
                                </div>
                                <div class="form-group">
                                    <label>Light Reading @ NID</label>
                                    <div class="input-wrapper">
                                        <input type="text" id="nid-light" class="form-control">
                                    </div>
                                </div>
                                <input type="hidden" id="details-nid-issues" />
                                <button type="button" id="return-splice-btn" class="btn btn-sm btn-danger-outline full-width hidden">
                                    <i data-lucide="rotate-ccw"></i> Reject Splice (Return to Admin)
                                </button>
                            </div>

                            <!-- Page: Install Ready -->
                            <div id="page-install-ready" class="details-page">
                                <label class="checkbox-row main-check">
                                    <input type="checkbox" id="check-install-ready" name="check-install-ready">
                                    <span>Install Scheduled</span>
                                </label>
                            </div>

                            <!-- Page: Install / Completed -->
                            <div id="page-install" class="details-page">
                                <div class="input-grid">
                                    <div class="form-group">
                                        <label>Install Date</label>
                                        <input type="date" id="install-date" class="form-control">
                                    </div>
                                </div>
                                
                                <div class="spacer"></div>
                                <label class="form-label">Additional Equipment</label>
                                <textarea id="extra-equip" rows="2" class="form-textarea"></textarea>
                                
                                <div class="spacer"></div>
                                <label class="form-label">Install Notes</label>
                                <textarea id="install-notes" rows="3" class="form-textarea"></textarea>
                                
                                <div class="spacer"></div>
                                <h4 style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-main);">Post-Install Checklist</h4>
                                <div class="checklist-stack">
                                    <label class="checkbox-row">
                                        <input type="checkbox" id="check-exempt-from-stats" name="check-exempt-from-stats">
                                        <span>Exempt from Avg Time Stats</span>
                                    </label>
                                    <label class="checkbox-row">
                                        <input type="checkbox" id="eero-info" name="eero-info">
                                        <span>Eero Insight Info Documented</span>
                                    </label>
                                    <label class="checkbox-row">
                                        <input type="checkbox" id="post-check-fiber" name="post-check-fiber">
                                        <span>Removed from Fiber List</span>
                                    </label>
                                    <label class="checkbox-row">
                                        <input type="checkbox" id="post-check-survey" name="post-check-survey">
                                        <span>Removed from Survey List</span>
                                    </label>
                                    <label class="checkbox-row">
                                        <input type="checkbox" id="post-check-repair" name="post-check-repair">
                                        <span>Updated Repair Shoppr</span>
                                    </label>
                                    <label class="checkbox-row">
                                        <input type="checkbox" id="bill-info" name="bill-info">
                                        <span>Email Sent to Billing</span>
                                    </label>
                                </div>

                                <div id="completed-actions-div" class="action-stack hidden" style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                                    <button type="button" id="copy-billing-btn" class="btn btn-secondary full-width">
                                        <i data-lucide="clipboard"></i> Copy Info for Billing
                                    </button>
                                    <button type="button" id="archive-customer-btn" class="btn btn-secondary full-width">
                                        <i data-lucide="archive"></i> Archive Customer
                                    </button>
                                    <button type="button" id="unarchive-customer-btn" class="btn btn-secondary full-width hidden">
                                        <i data-lucide="refresh-ccw"></i> Unarchive
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- FOOTER ACTIONS -->
                        <div class="details-footer">
                            <button type="button" id="on-hold-btn" class="btn btn-warning-outline">
                                <i data-lucide="pause-circle"></i> <span>Hold</span>
                            </button>
                            <div class="flex-spacer"></div>
                            <button type="button" id="delete-customer-btn" class="btn btn-danger-ghost">
                                <i data-lucide="trash-2"></i> Delete
                            </button>
                        </div>

                        <!-- HIDDEN FIELDS FOR LOGIC PRESERVATION -->
                        <input type="hidden" id="details-status" name="details-status" />
                        <!-- Redundant buttons required by old logic but hidden in UI to prevent errors if logic calls them -->
                        <button type="button" id="header-save-btn" class="hidden"></button>
                        <button type="button" id="header-save-and-progress-btn" class="hidden"></button>

                    </form>
                </div>
            </main>
        </div>
    </div>

    <div id="toast-notification"></div>

    <!-- ADD CUSTOMER MODAL -->
    <div id="add-customer-modal" class="modal-container">
        <div class="modal-backdrop"></div>
        <div class="modal-panel">
            <div class="modal-header">
                <h3>New Service Order</h3>
                <button id="modal-close-btn" class="btn-icon-only"><i data-lucide="x"></i></button>
            </div>
            
            <form id="add-customer-form" class="modal-content">
                <div class="pdf-upload-section">
                    <label>Auto-fill from PDF</label>
                    <div id="pdf-drop-zone" class="pdf-zone">
                        <i data-lucide="upload-cloud"></i>
                        <span id="selected-file-name">Drop PDF here or click to browse</span>
                        <input type="file" id="pdf-upload" accept=".pdf" class="hidden">
                    </div>
                    <button type="button" id="process-pdf-btn" class="btn btn-sm btn-secondary full-width" disabled>Process PDF</button>
                    <p id="pdf-status-msg" class="status-msg" style="font-size:0.75rem; text-align:center; margin-top:0.5rem;"></p>
                </div>

                <div class="divider"><span>OR MANUAL ENTRY</span></div>

                <div class="input-grid single-col">
                    <div class="form-group">
                        <label>Service Order #</label>
                        <input type="text" id="so-number" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Customer Name</label>
                        <input type="text" id="customer-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="address" rows="2" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group grid-2">
                        <div>
                            <label>Email</label>
                            <input type="email" id="customer-email" class="form-control">
                        </div>
                        <div>
                            <label>Phone</label>
                            <input type="tel" id="customer-phone" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Speed</label>
                        <select id="service-speed" class="form-select">
                            <option>200 Mbps</option>
                            <option>500 Mbps</option>
                            <option>1 Gbps</option>
                        </select>
                    </div>
                </div>
                
                <div class="modal-footer" style="margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary full-width">Create Order</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs" type="module"></script>
    <script type="module" src="firebase.js"></script>
    <script type="module" src="app.js"></script>
    
    <script>
        window.addEventListener('load', () => {
            if (window.lucide) window.lucide.createIcons();
        });
    </script>

</body>
</html>